---
import Layout from "../layouts/Layout.astro";
import { galleryImages, categories } from "../lib/gallery";
---

<Layout>
    <section class="min-h-screen gallery-section">
        <!-- Header -->
        <div class="gallery-header">
            <h1 class="page-title">Gallery</h1>
            <p class="page-subtitle">
                Explore our journey through competitions, workshops, and aircraft development
            </p>
        </div>

        <!-- Controls Container -->
        <div class="controls-container">
            <!-- Search Bar -->
            <div class="search-container">
                <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input
                    type="text"
                    id="search-input"
                    class="search-input"
                    placeholder="Search images..."
                    aria-label="Search gallery images"
                />
            </div>

            <!-- Category Filters -->
            <div class="filter-container">
                {categories.map((category) => (
                    <button
                        class={`filter-btn ${category === "All" ? "active" : ""}`}
                        data-category={category}
                    >
                        {category}
                    </button>
                ))}
            </div>
        </div>

        <!-- Gallery Grid (Masonry Layout) -->
        <div class="gallery-grid" id="gallery-grid">
            {galleryImages.map((image, index) => (
                <div
                    class="gallery-item"
                    data-category={image.category}
                    data-title={image.title.toLowerCase()}
                    data-desc={image.desc.toLowerCase()}
                    data-index={index}
                >
                    <div class="image-wrapper group">
                        <img
                            src={image.src}
                            alt={image.desc}
                            loading="lazy"
                            class="gallery-image"
                        />
                        <div class="image-overlay">
                            <div class="overlay-content">
                                <h3 class="image-title">{image.title}</h3>
                                <p class="image-category">{image.category}</p>
                            </div>
                        </div>
                    </div>
                </div>
            ))}
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="no-results hidden">
            <svg class="no-results-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <p class="no-results-text">No images found</p>
            <p class="no-results-subtext">Try adjusting your search or filters</p>
        </div>

        <!-- Lightbox Modal -->
        <div id="lightbox" class="lightbox hidden">
            <div class="lightbox-backdrop"></div>
            <div class="lightbox-content">
                <button class="lightbox-close" aria-label="Close lightbox">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>

                <button class="lightbox-nav lightbox-prev" aria-label="Previous image">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>

                <button class="lightbox-nav lightbox-next" aria-label="Next image">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>

                <div class="lightbox-image-container">
                    <img id="lightbox-image" src="" alt="" class="lightbox-image" />
                </div>

                <div class="lightbox-info">
                    <h3 id="lightbox-title" class="lightbox-title"></h3>
                    <p id="lightbox-desc" class="lightbox-desc"></p>
                    <span id="lightbox-category" class="lightbox-category"></span>
                </div>
            </div>
        </div>
    </section>
</Layout>

<style>
    .gallery-section {
        @apply min-h-screen px-4 py-20 bg-gradient-to-b from-gray-900 to-gray-800;
    }

    .gallery-header {
        @apply text-center mb-12 pt-8;
    }

    .page-title {
        @apply text-5xl md:text-6xl font-bold text-vyoma-blue mb-4;
    }

    .page-subtitle {
        @apply text-lg md:text-xl text-gray-300 max-w-2xl mx-auto;
    }

    .controls-container {
        @apply max-w-7xl mx-auto mb-8 space-y-6;
    }

    /* Search Bar */
    .search-container {
        @apply relative max-w-xl mx-auto;
    }

    .search-icon {
        @apply absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400;
    }

    .search-input {
        @apply w-full pl-12 pr-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all;
    }

    /* Category Filters */
    .filter-container {
        @apply flex flex-wrap justify-center gap-3;
    }

    .filter-btn {
        @apply px-6 py-2 bg-gray-800 text-gray-300 rounded-full border border-gray-700 hover:border-cyan-500 hover:text-cyan-400 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-cyan-500/50;
    }

    .filter-btn.active {
        @apply bg-cyan-600 text-white border-cyan-600 hover:bg-cyan-700 hover:border-cyan-700;
    }

    /* Masonry Gallery Grid */
    .gallery-grid {
        @apply max-w-7xl mx-auto columns-1 sm:columns-2 lg:columns-3 xl:columns-4 gap-4 space-y-4;
    }

    .gallery-item {
        @apply break-inside-avoid mb-4 transition-all duration-300;
    }

    .gallery-item.hidden {
        display: none;
    }

    .image-wrapper {
        @apply relative overflow-hidden rounded-lg shadow-lg cursor-pointer bg-gray-800;
    }

    .gallery-image {
        @apply w-full h-auto object-cover transition-transform duration-500 group-hover:scale-110;
    }

    .image-overlay {
        @apply absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end;
    }

    .overlay-content {
        @apply p-4 w-full;
    }

    .image-title {
        @apply text-white font-bold text-lg mb-1;
    }

    .image-category {
        @apply text-cyan-400 text-sm;
    }

    /* No Results */
    .no-results {
        @apply text-center py-20;
    }

    .no-results.hidden {
        display: none;
    }

    .no-results-icon {
        @apply w-16 h-16 mx-auto mb-4 text-gray-600;
    }

    .no-results-text {
        @apply text-2xl font-semibold text-gray-400 mb-2;
    }

    .no-results-subtext {
        @apply text-gray-500;
    }

    /* Lightbox */
    .lightbox {
        @apply fixed inset-0 z-50 flex items-center justify-center p-4;
    }

    .lightbox.hidden {
        display: none;
    }

    .lightbox-backdrop {
        @apply absolute inset-0 bg-black/95 backdrop-blur-sm;
    }

    .lightbox-content {
        @apply relative z-10 w-full max-w-6xl max-h-[90vh] flex flex-col;
    }

    .lightbox-close {
        @apply absolute top-4 right-4 z-20 w-10 h-10 bg-black/50 hover:bg-black/70 rounded-full flex items-center justify-center text-white transition-all focus:outline-none focus:ring-2 focus:ring-cyan-500;
    }

    .lightbox-close svg {
        @apply w-6 h-6;
    }

    .lightbox-nav {
        @apply absolute top-1/2 -translate-y-1/2 z-20 w-12 h-12 bg-black/50 hover:bg-black/70 rounded-full flex items-center justify-center text-white transition-all focus:outline-none focus:ring-2 focus:ring-cyan-500;
    }

    .lightbox-nav svg {
        @apply w-6 h-6;
    }

    .lightbox-prev {
        @apply left-4;
    }

    .lightbox-next {
        @apply right-4;
    }

    .lightbox-image-container {
        @apply flex-1 flex items-center justify-center overflow-hidden mb-4;
    }

    .lightbox-image {
        @apply max-w-full max-h-[60vh] object-contain rounded-lg;
    }

    .lightbox-info {
        @apply bg-gray-900/90 rounded-lg p-6 backdrop-blur-sm;
    }

    .lightbox-title {
        @apply text-2xl font-bold text-white mb-2;
    }

    .lightbox-desc {
        @apply text-gray-300 mb-3;
    }

    .lightbox-category {
        @apply inline-block px-3 py-1 bg-cyan-600 text-white text-sm rounded-full;
    }

    /* Mobile Responsive */
    @media (max-width: 640px) {
        .page-title {
            @apply text-4xl;
        }

        .lightbox-nav {
            @apply w-10 h-10;
        }

        .lightbox-nav svg {
            @apply w-5 h-5;
        }

        .lightbox-title {
            @apply text-xl;
        }

        .lightbox-info {
            @apply p-4;
        }
    }
</style>

<script define:vars={{ galleryImages }}>
    let currentImageIndex = 0;
    let filteredImages = [...galleryImages];

    // Initialize gallery
    document.addEventListener('DOMContentLoaded', () => {
        setupFilters();
        setupSearch();
        setupLightbox();
    });

    // Category Filters
    function setupFilters() {
        const filterButtons = document.querySelectorAll('.filter-btn');
        const galleryItems = document.querySelectorAll('.gallery-item');

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const category = button.getAttribute('data-category');

                // Update active state
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // Filter images
                filterImages(category, getCurrentSearchTerm());
            });
        });
    }

    // Search Functionality
    function setupSearch() {
        const searchInput = document.getElementById('search-input');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase();
                const activeCategory = document.querySelector('.filter-btn.active').getAttribute('data-category');
                filterImages(activeCategory, searchTerm);
            }, 300);
        });
    }

    function getCurrentSearchTerm() {
        const searchInput = document.getElementById('search-input');
        return searchInput ? searchInput.value.toLowerCase() : '';
    }

    function filterImages(category, searchTerm) {
        const galleryItems = document.querySelectorAll('.gallery-item');
        const noResults = document.getElementById('no-results');
        let visibleCount = 0;

        filteredImages = [];

        galleryItems.forEach((item, index) => {
            const itemCategory = item.getAttribute('data-category');
            const itemTitle = item.getAttribute('data-title');
            const itemDesc = item.getAttribute('data-desc');

            const categoryMatch = category === 'All' || itemCategory === category;
            const searchMatch = !searchTerm ||
                itemTitle.includes(searchTerm) ||
                itemDesc.includes(searchTerm) ||
                itemCategory.toLowerCase().includes(searchTerm);

            if (categoryMatch && searchMatch) {
                item.classList.remove('hidden');
                filteredImages.push({ ...galleryImages[index], originalIndex: index });
                visibleCount++;
            } else {
                item.classList.add('hidden');
            }
        });

        // Show/hide no results message
        if (visibleCount === 0) {
            noResults.classList.remove('hidden');
        } else {
            noResults.classList.add('hidden');
        }
    }

    // Lightbox
    function setupLightbox() {
        const galleryItems = document.querySelectorAll('.gallery-item');
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxTitle = document.getElementById('lightbox-title');
        const lightboxDesc = document.getElementById('lightbox-desc');
        const lightboxCategory = document.getElementById('lightbox-category');
        const closeBtn = document.querySelector('.lightbox-close');
        const prevBtn = document.querySelector('.lightbox-prev');
        const nextBtn = document.querySelector('.lightbox-next');

        // Open lightbox
        galleryItems.forEach((item) => {
            item.addEventListener('click', () => {
                const index = parseInt(item.getAttribute('data-index'));
                openLightbox(index);
            });
        });

        // Close lightbox
        closeBtn.addEventListener('click', closeLightbox);
        lightbox.querySelector('.lightbox-backdrop').addEventListener('click', closeLightbox);

        // Navigation
        prevBtn.addEventListener('click', () => navigateLightbox(-1));
        nextBtn.addEventListener('click', () => navigateLightbox(1));

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('hidden')) {
                if (e.key === 'Escape') closeLightbox();
                if (e.key === 'ArrowLeft') navigateLightbox(-1);
                if (e.key === 'ArrowRight') navigateLightbox(1);
            }
        });

        function openLightbox(index) {
            currentImageIndex = index;
            updateLightboxContent();
            lightbox.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            lightbox.classList.add('hidden');
            document.body.style.overflow = '';
        }

        function navigateLightbox(direction) {
            const totalImages = galleryImages.length;
            currentImageIndex = (currentImageIndex + direction + totalImages) % totalImages;
            updateLightboxContent();
        }

        function updateLightboxContent() {
            const image = galleryImages[currentImageIndex];
            lightboxImage.src = image.src;
            lightboxImage.alt = image.desc;
            lightboxTitle.textContent = image.title;
            lightboxDesc.textContent = image.desc;
            lightboxCategory.textContent = image.category;
        }
    }
</script>
